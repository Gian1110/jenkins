@Library('jenkins-libs') _
pipeline {
  agent any
 parameters {
    
    //server values
        string(name: 'remoteHost', defaultValue: '192.168.100.173', description: 'dns o ip del host')
        string(name: 'imagenver', defaultValue: 'latest', description: 'version de la applicacion')
        
    }
    environment {
        //path app
        path="./dockerweb-multiserver"
      

        // container values
        name_container = 'proyecto-qa'
        name_imagen_origen = 'iproyecto-qa'
        puerto_imagen = '81'
        name_imagen = "192.168.100.173:5000/${name_imagen_origen}:${imagenver}"   

    }
    stages {

        // stage('build and push') {
        //     steps {
        //         script{
        //             def parameterMap = [:]
        //             parameterMap["path"] = path
        //             parameterMap["nameContainer"] = name_container
        //             dockerBuildandPush(parameterMap);
        //             }
                    
        //         }                    
                                  
        //     }
        stage('build') {
            steps {
                script{
                    def nameImagen = ConfigJenkins.getImagenRegistry(name_container,imagenver)
                    sh "docker build -t ${nameImagen} dockerweb-multiserver/"
    
                    }
                    
                }                    
                                  
            }
            stage('push') {
            steps {
                script{
                    def nameImagen = ConfigJenkins.getImagenRegistry(name_container,imagenver)
                    sh "docker push ${nameImagen}"
                 
    
                    }
                    
                }                    
                                  
            }

            stage('rmi') {
            steps {
                script{
                    def nameImagen = ConfigJenkins.getImagenRegistry(name_container,imagenver)
                   
                    sh "docker rmi ${nameImagen}"
    
                    }
                    
                }                    
                                  
            }
        stage('ssh pull') {
            steps {
                script{
                        def parameterMap = [:]
                        parameterMap["remoteHost"] = params.remoteHost
                        parameterMap["nameContainer"] = name_container
                        parameterMap["versionImagen"] = imagenver
                        dockerb.dockerPull(parameterMap);
                            
                    }
                    
                }  
            
            }

        stage('ssh rm and run') {
            steps {
                script{

                    def parameterMap = [:]
                    parameterMap["remoteHost"] = params.remoteHost
                    parameterMap["nameContainer"] = name_container
                    parameterMap["puertoContainer"] = puerto_imagen
                    dockerb.dockerRmRun(parameterMap);
                    
                    }
                }  
            
            }
        }

    }
