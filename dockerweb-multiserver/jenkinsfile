@Library('jenkins-libs') _
pipeline {
  agent any
 parameters {
    
    //server values
        string(name: 'remoteHost', defaultValue: '192.168.100.173', description: 'dns o ip del host')
        string(name: 'version_imagen', defaultValue: 'latest', description: 'version de la applicacion')
        
    }
    environment {
        //registry values
        hostname_registry = '192.168.100.173'
        port_registry = '5000'

        // container values
        name_container = 'proyecto-qa'
        name_imagen_origen = 'iproyecto-qa'
        puerto_imagen = '81'
        name_imagen = "${hostname_registry}:${port_registry}/${name_imagen_origen}:${version_imagen}"   

    }
    stages {

        stage('build and push') {
            steps {
                script{
                    sh ''' 
                    docker build -t ${name_imagen} dockerweb-multiserver/
                    docker push ${name_imagen}
                    docker rmi ${name_imagen}
                    '''
                    }
                    
                }                    
                                  
            }

        stage('ssh pull') {
            steps {
                script{
                        def parameterMap = [:]
                        parameterMap["remoteHost"] = params.remoteHost
                        parameterMap["nameImagen"] = name_imagen
                        dockerb.dockerPull(parameterMap);
                            
                    }
                    
                }  
            
            }

        stage('ssh rm') {
            steps {
                script{

                    def parameterMap = [:]
                    parameterMap["remoteHost"] = params.remoteHost
                    parameterMap["nameContainer"] = name_container
                    dockerb.dockerStopRm(parameterMap);

                    }
                }  
            
            }

        stage('ssh run') {
            steps {
                script{

                    def parameterMap = [:]
                    parameterMap["remoteHost"] = params.remoteHost
                    parameterMap["nameContainer"] = name_container
                    parameterMap["nameImagen"] = name_imagen
                    parameterMap["puertoContainer"] = puerto_imagen
                    dockerb.dockerStopRm(parameterMap);
                    
                    }
                }  
            
            }
        }

    }
